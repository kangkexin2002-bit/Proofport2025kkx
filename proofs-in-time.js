const receiptData = {
    '24.9': {
        receipts: [
            '24.9收据01.png', '24.9收据02.png', '24.9收据03.png', '24.9收据04.png', '24.9收据05.png',
            '24.9收据06.png', '24.9收据07.png', '24.9收据08.png', '24.9收据09.png', '24.9收据10.png',
            '24.9收据11.png', '24.9收据12.png', '24.9收据13.png', '24.9收据14.png', '24.9收据15.png',
            '24.9收据16.png', '24.9收据17.png', '24.9收据18.png', '24.9收据19.png', '24.9收据20.png', '24.9收据21.png'
        ],
        times: [
            '24.9时间01.png', '24.9时间02.png', '24.9时间03.png', '24.9时间04.png', '24.9时间05.png',
            '24.9时间06.png', '24.9时间07.png', '24.9时间08.png', '24.9时间09.png', '24.9时间10.png',
            '24.9时间11.png', '24.9时间12.png', '24.9时间13.png', '24.9时间14.png', '24.9时间15.png',
            '24.9时间16.png', '24.9时间17.png', '24.9时间18.png', '24.9时间19.png', '24.9时间20.png', '24.9时间21.png'
        ]
    },
    '24.10': {
        receipts: [
            '24.10收据01.png', '24.10收据02.png', '24.10收据03.png', '24.10收据04.png', '24.10收据05.png',
            '24.10收据06.png', '24.10收据07.png', '24.10收据08.png', '24.10收据09.png', '24.10收据10.png',
            '24.10收据11.png', '24.10收据12.png', '24.10收据13.png', '24.10收据14.png', '24.10收据15.png',
            '24.10收据16.png', '24.10收据17.png', '24.10收据18.png', '24.10收据19.png', '24.10收据20.png',
            '24.10收据21.png', '24.10收据22.png', '24.10收据23.png', '24.10收据24.png', '24.10收据25.png',
            '24.10收据26.png', '24.10收据27.png', '24.10收据28.png', '24.10收据29.png', '24.10收据30.png'
        ],
        times: [
            '24.10时间01.png', '24.10时间02.png', '24.10时间03.png', '24.10时间04.png', '24.10时间05.png',
            '24.10时间06.png', '24.10时间07.png', '24.10时间08.png', '24.10时间09.png', '24.10时间10.png',
            '24.10时间11.png', '24.10时间12.png', '24.10时间13.png', '24.10时间14.png', '24.10时间15.png',
            '24.10时间16.png', '24.10时间17.png', '24.10时间18.png', '24.10时间19.png', '24.10时间20.png',
            '24.10时间21.png', '24.10时间22.png', '24.10时间23.png', '24.10时间24.png', '24.10时间25.png',
            '24.10时间26.png', '24.10时间27.png', '24.10时间28.png', '24.10时间29.png', '24.10时间30.png'
        ]
    },
    '24.11': {
        receipts: [
            '24.11收据01.png', '24.11收据02.png', '24.11收据03.png', '24.11收据04.png', '24.11收据05.png',
            '24.11收据06.png', '24.11收据07.png', '24.11收据08.png', '24.11收据09.png', '24.11收据10.png',
            '24.11收据11.png', '24.11收据12.png', '24.11收据13.png', '24.11收据14.png', '24.11收据15.png',
            '24.11收据16.png', '24.11收据17.png', '24.11收据18.png', '24.11收据19.png', '24.11收据20.png',
            '24.11收据21.png', '24.11收据22.png'
        ],
        times: [
            '24.11时间01.png', '24.11时间02.png', '24.11时间03.png', '24.11时间04.png', '24.11时间05.png',
            '24.11时间06.png', '24.11时间07.png', '24.11时间08.png', '24.11时间09.png', '24.11时间10.png',
            '24.11时间11.png', '24.11时间12.png', '24.11时间13.png', '24.11时间14.png', '24.11时间15.png',
            '24.11时间16.png', '24.11时间17.png', '24.11时间18.png', '24.11时间19.png', '24.11时间20.png',
            '24.11时间21.png', '24.11时间22.png'
        ]
    },
    '24.12': {
        receipts: [
            '24.12收据01.png', '24.12收据02.png', '24.12收据03.png', '24.12收据04.png', '24.12收据05.png',
            '24.12收据06.png', '24.12收据07.png', '24.12收据08.png', '24.12收据09.png', '24.12收据10.png',
            '24.12收据11.png', '24.12收据12.png', '24.12收据13.png', '24.12收据14.png', '24.12收据15.png',
            '24.12收据16.png', '24.12收据17.png', '24.12收据18.png', '24.12收据19.png', '24.12收据20.png',
            '24.12收据21.png', '24.12收据22.png', '24.12收据23.png', '24.12收据24.png', '24.12收据25.png'
        ],
        times: [
            '24.12时间01.png', '24.12时间02.png', '24.12时间03.png', '24.12时间04.png', '24.12时间05.png',
            '24.12时间06.png', '24.12时间07.png', '24.12时间08.png', '24.12时间09.png', '24.12时间10.png',
            '24.12时间11.png', '24.12时间12.png', '24.12时间13.png', '24.12时间14.png', '24.12时间15.png',
            '24.12时间16.png', '24.12时间17.png', '24.12时间18.png', '24.12时间19.png', '24.12时间20.png',
            '24.12时间21.png', '24.12时间22.png', '24.12时间23.png', '24.12时间24.png', '24.12时间25.png'
        ]
    },
    '25.1': {
        receipts: [
            '25.1收据1.png', '25.1收据02.png', '25.1收据03.png', '25.1收据04.png', '25.1收据05.png',
            '25.1收据06.png', '25.1收据07.png', '25.1收据08.png', '25.1收据09.png', '25.1收据10.png',
            '25.1收据11.png', '25.1收据12.png', '25.1收据13.png', '25.1收据14.png', '25.1收据15.png',
            '25.1收据16.png', '25.1收据17.png', '25.1收据18.png', '25.1收据19.png', '25.1收据20.png',
            '25.1收据21.png', '25.1收据22.png', '25.1收据23.png', '25.1收据24.png'
        ],
        times: [
            '25.1时间01.png', '25.1时间02.png', '25.1时间03.png', '25.1时间04.png', '25.1时间05.png',
            '25.1时间06.png', '25.1时间07.png', '25.1时间08.png', '25.1时间09.png', '25.1时间10.png',
            '25.1时间11.png', '25.1时间12.png', '25.1时间13.png', '25.1时间14.png', '25.1时间15.png',
            '25.1时间16.png', '25.1时间17.png', '25.1时间18.png', '25.1时间19.png', '25.1时间20.png',
            '25.1时间21.png', '25.1时间22.png', '25.1时间23.png', '25.1时间24.png'
        ]
    },
    '25.2': {
        receipts: [
            '25.2收据01.png', '25.2收据02.png', '25.2收据03.png', '25.2收据04.png', '25.2收据05.png',
            '25.2收据06.png', '25.2收据07.png', '25.2收据08.png', '25.2收据09.png', '25.2收据10.png',
            '25.2收据11.png', '25.2收据12.png', '25.2收据13.png', '25.2收据14.png', '25.2收据15.png',
            '25.2收据16.png', '25.2收据17.png', '25.2收据18.png', '25.2收据19.png', '25.2收据20.png',
            '25.2收据21.png', '25.2收据22.png', '25.2收据23.png'
        ],
        times: [
            '25.2时间01.png', '25.2时间02.png', '25.2时间03.png', '25.2时间04.png', '25.2时间05.png',
            '25.2时间06.png', '25.2时间07.png', '25.2时间08.png', '25.2时间09.png', '25.2时间10.png',
            '25.2时间11.png', '25.2时间12.png', '25.2时间13.png', '25.2时间14.png', '25.2时间15.png',
            '25.2时间16.png', '25.2时间17.png', '25.2时间18.png', '25.2时间19.png', '25.2时间20.png',
            '25.2时间21.png', '25.2时间22.png', '25.2时间23.png'
        ]
    },
    '25.3': {
        receipts: [
            '25.3收据01.png', '25.3收据02.png', '25.3收据03.png', '25.3收据04.png', '25.3收据05.png',
            '25.3收据06.png', '25.3收据07.png', '25.3收据08.png', '25.3收据09.png', '25.3收据10.png',
            '25.3收据11.png', '25.3收据12.png', '25.3收据13.png', '25.3收据14.png', '25.3收据15.png',
            '25.3收据16.png', '25.3收据17.png', '25.3收据18.png', '25.3收据19.png', '25.3收据20.png'
        ],
        times: [
            '25.3时间01.png', '25.3时间02.png', '25.3时间03.png', '25.3时间04.png', '25.3时间05.png',
            '25.3时间06.png', '25.3时间07.png', '25.3时间08.png', '25.3时间09.png', '25.3时间10.png',
            '25.3时间11.png', '25.3时间12.png', '25.3时间13.png', '25.3时间14.png', '25.3时间15.png',
            '25.3时间16.png', '25.3时间17.png', '25.3时间18.png', '25.3时间19.png', '25.3时间20.png'
        ]
    },
    '25.4': {
        receipts: [
            '25.4收据01.png', '25.4收据02.png', '25.4收据03.png', '25.4收据04.png', '25.4收据05.png',
            '25.4收据06.png', '25.4收据07.png', '25.4收据08.png', '25.4收据09.png', '25.4收据10.png',
            '25.4收据11.png', '25.4收据12.png', '25.4收据13.png'
        ],
        times: [
            '25.4时间01.png', '25.4时间02.png', '25.4时间03.png', '25.4时间04.png', '25.4时间05.png',
            '25.4时间06.png', '25.4时间07.png', '25.4时间08.png', '25.4时间09.png', '25.4时间10.png',
            '25.4时间11.png', '25.4时间12.png', '25.4时间13.png'
        ]
    },
    '25.5': {
        receipts: [
            '25.5收据01.png', '25.5收据02.png', '25.5收据03.png', '25.5收据04.png', '25.5收据05.png',
            '25.5收据06.png', '25.5收据07.png', '25.5收据08.png', '25.5收据09.png', '25.5收据10.png', '25.5收据11.png'
        ],
        times: [
            '25.5时间01.png', '25.5时间02.png', '25.5时间03.png', '25.5时间04.png', '25.5时间05.png',
            '25.5时间06.png', '25.5时间07.png', '25.5时间08.png', '25.5时间09.png', '25.5时间10.png', '25.5时间11.png'
        ]
    },
    '25.6': {
        receipts: [
            '25.6收据01.png', '25.6收据02.png', '25.6收据03.png', '25.6收据04.png', '25.6收据05.png',
            '25.6收据06.png', '25.6收据07.png', '25.6收据08.png', '25.6收据09.png', '25.6收据10.png',
            '25.6收据11.png', '25.6收据12.png', '25.6收据13.png', '25.6收据14.png', '25.6收据15.png', '25.6收据16.png'
        ],
        times: [
            '25.6时间01.png', '25.6时间02.png', '25.6时间03.png', '25.6时间04.png', '25.6时间05.png',
            '25.6时间06.png', '25.6时间07.png', '25.6时间08.png', '25.6时间09.png', '25.6时间10.png',
            '25.6时间11.png', '25.6时间12.png', '25.6时间13.png', '25.6时间14.png', '25.6时间15.png', '25.6时间16.png'
        ]
    },
    '25.7': {
        receipts: [
            '25.7收据01.png', '25.7收据02.png', '25.7收据03.png', '25.7收据04.png', '25.7收据05.png',
            '25.7收据06.png', '25.7收据07.png', '25.7收据08.png', '25.7收据09.png', '25.7收据10.png',
            '25.7收据11.png', '25.7收据12.png', '25.7收据13.png', '25.7收据14.png', '25.7收据15.png', '25.7收据16.png'
        ],
        times: [
            '25.7时间01.png', '25.7时间02.png', '25.7时间03.png', '25.7时间04.png', '25.7时间05.png',
            '25.7时间06.png', '25.7时间07.png', '25.7时间08.png', '25.7时间09.png', '25.7时间10.png',
            '25.7时间11.png', '25.7时间12.png', '25.7时间13.png', '25.7时间14.png', '25.7时间15.png', '25.7时间16.png'
        ]
    }
};

let countdownInterval;
let totalTimeInSeconds = 12408 * 3600; 
let currentTimeInSeconds = totalTimeInSeconds;
let allImages = [];
let lastFadeTime = 0;
let fadeInterval = 202066.06; 

document.addEventListener('DOMContentLoaded', function() {

    window.scrollTo(0, 0);
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;

    initializeImages();
    initializeCountdown();
    initializeNavigation();
    initializeGreenOverlay();
    initializeImageInteraction();
    initializeCountdownAnimation();

    setTimeout(() => {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
        console.log('Page forced to top position');
    }, 100);
});

window.addEventListener('load', function() {
    window.scrollTo(0, 0);
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    console.log('Window loaded - forced to top position');
});

function initializeImages() {
    const backgroundImages = document.querySelector('.background-images');
    const months = Object.keys(receiptData);

    const containerWidth = window.innerWidth;
    const containerHeight = window.innerHeight;
    const headerHeight = 120; 
    const footerHeight = 100; 
    const sideMargin = 80; 

    const availableWidth = containerWidth - (sideMargin * 2);
    const availableHeight = containerHeight - headerHeight - footerHeight;

    const imgWidth = 150;
    const imgHeight = 200;
    const padding = 20; 

    const cols = Math.floor(availableWidth / (imgWidth + padding));
    const rows = Math.ceil(availableHeight / (imgHeight + padding));

    let imageCount = 0;
    let totalImages = 0;

    months.forEach(month => {
        totalImages += receiptData[month].receipts.length;
    });

    const positions = [];
    for (let row = 0; row < Math.ceil(totalImages / cols); row++) {
        for (let col = 0; col < cols && positions.length < totalImages; col++) {
            const x = sideMargin + col * (imgWidth + padding) + (availableWidth - cols * (imgWidth + padding)) / 2;
            const y = headerHeight + row * (imgHeight + padding);
            positions.push({ x, y });
        }
    }

    for (let i = positions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [positions[i], positions[j]] = [positions[j], positions[i]];
    }

    months.forEach((month, monthIndex) => {
        const monthData = receiptData[month];

        monthData.receipts.forEach((receipt, index) => {
            if (imageCount >= positions.length) return;

            const img = document.createElement('img');
            let folderName = `${month}完成图（白描边`;
            if (month === '25.5') folderName = `${month}完成图(白描边`;
            if (month === '25.7') folderName = `${month}完成图（白描边）`;

            const imagePath = `A页图片文案需求/A页image/${folderName}/${receipt}`;
            img.src = encodeURI(imagePath);
            img.className = 'receipt-img';
            img.dataset.month = month;
            img.dataset.index = index;
            img.dataset.fadeOrder = allImages.length; 
            img.dataset.receiptFile = receipt;

            const position = positions[imageCount];
            const x = position.x + (Math.random() - 0.5) * 20; 
            const y = position.y + (Math.random() - 0.5) * 20;

            img.style.left = x + 'px';
            img.style.top = y + 'px';
            img.style.zIndex = '250'; 

            img.dataset.initialX = x;
            img.dataset.initialY = y;

            backgroundImages.appendChild(img);
            allImages.push(img);

            imageCount++;
        });
    });

    const calculatedHeight = Math.max(containerHeight, Math.ceil(totalImages / cols) * (imgHeight + padding) + headerHeight + footerHeight);
    const minScrollableHeight = window.innerHeight * 2; 
    const finalHeight = Math.max(calculatedHeight, minScrollableHeight);

    backgroundImages.style.height = finalHeight + 'px';

    const proofsContainer = document.querySelector('.proofs-container');
    if (proofsContainer) {
        proofsContainer.style.minHeight = finalHeight + 'px';
    }

    console.log(`Initialized ${allImages.length} receipt images in grid layout, height: ${finalHeight}px`);
}

function initializeCountdown() {
    updateCountdownDisplay();

    countdownInterval = setInterval(() => {
        currentTimeInSeconds--;

        if (currentTimeInSeconds <= 0) {
            clearInterval(countdownInterval);
            currentTimeInSeconds = 0;
        }

        updateCountdownDisplay();
        handleImageFading();

    }, 1000); 
}

function updateCountdownDisplay() {
    const hours = Math.floor(currentTimeInSeconds / 3600);
    const minutes = Math.floor((currentTimeInSeconds % 3600) / 60);
    const seconds = currentTimeInSeconds % 60;

    const timeString = `${hours.toString().padStart(5, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

    document.getElementById('countdownTimer').textContent = timeString;

    const mainTitle = document.querySelector('.main-title');
    if (mainTitle) {
        mainTitle.textContent = timeString;
    }
}

function handleImageFading() {
    const elapsedSeconds = totalTimeInSeconds - currentTimeInSeconds;
    const imagesToFade = Math.floor(elapsedSeconds / fadeInterval);

    if (imagesToFade > lastFadeTime && imagesToFade < allImages.length) {
        const imageToFade = allImages[imagesToFade];
        if (imageToFade && !imageToFade.classList.contains('hidden')) {
            imageToFade.classList.add('receipt-fade-out');
            setTimeout(() => {
                imageToFade.classList.add('hidden');
            }, 2000);
        }
        lastFadeTime = imagesToFade;
    }
}

function initializeNavigation() {
    const navToggle = document.getElementById('navToggle');
    const navDropdown = document.getElementById('navDropdown');
    const navOptions = document.querySelectorAll('.nav-option');

    navToggle.addEventListener('click', function() {
        navDropdown.classList.toggle('active');
    });

    document.addEventListener('click', function(e) {
        if (!navToggle.contains(e.target) && !navDropdown.contains(e.target)) {
            navDropdown.classList.remove('active');
        }
    });

    navOptions.forEach(option => {
        option.addEventListener('click', function() {
            const state = this.dataset.state;

            navOptions.forEach(opt => opt.classList.remove('active'));

            this.classList.add('active');

            switch(state) {
                case 'home':
                    window.location.href = 'home.html';
                    break;
                case 'proofs-in-time':

                    break;
                case 'proofs-reborn':
                    window.location.href = 'proofs-reborn.html';
                    break;
                case 'ports-of-proof':
                    window.location.href = 'ports-of-proof.html';
                    break;
            }

            navDropdown.classList.remove('active');
        });
    });
}

function initializeGreenOverlay() {
    const greenTextOverlay = document.getElementById('greenTextOverlay');
    const greenTextContent = document.querySelector('.green-text-content');
    const backgroundImages = document.querySelector('.background-images');
    let scrollAccumulation = 0;
    const scrollThreshold = 100;

    document.addEventListener('wheel', function(e) {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const bottomThreshold = 50; 

        const isAtBottom = scrollTop + windowHeight >= documentHeight - bottomThreshold;
        const isOverlayActive = greenTextOverlay.classList.contains('scroll-active');
        const computedTransform = getComputedStyle(greenTextOverlay).transform;
        const isOverlayVisible = computedTransform.includes('matrix') && !computedTransform.includes('matrix(1, 0, 0, 1, 0, ');

        console.log('Scroll event:', {
            deltaY: e.deltaY,
            scrollTop: scrollTop,
            windowHeight: windowHeight,
            documentHeight: documentHeight,
            isAtBottom: isAtBottom,
            isOverlayActive: isOverlayActive,
            isOverlayVisible: isOverlayVisible,
            overlayTransform: computedTransform
        });

        if (isOverlayActive) {

            if (e.deltaY < 0) {
                greenTextOverlay.classList.remove('scroll-active');
                scrollAccumulation = 0;
                console.log('✓ Overlay closed by upward scroll');

                return;
            } else {

                e.preventDefault();
                console.log('✓ Overlay active - preventing downward scroll');
                return;
            }
        }

        if (isAtBottom && !isOverlayActive) {

            if (e.deltaY > 0) {
                e.preventDefault();
                scrollAccumulation += e.deltaY;
                console.log('At bottom - handling overlay (downward)', scrollAccumulation);

                if (scrollAccumulation > scrollThreshold) {
                    greenTextOverlay.classList.add('scroll-active');
                    scrollAccumulation = 0;
                    console.log('✓ Overlay activated');
                }
            } else {

                scrollAccumulation = 0;
                console.log('At bottom but scrolling up - allowing normal scroll');
                return;
            }
        } else if (!isAtBottom) {

            console.log('Not at bottom - allowing normal scroll');
            scrollAccumulation = 0; 
            return;
        }
    }, { passive: false });

    let touchStartY = 0;
    let touchStartTime = 0;

    document.addEventListener('touchstart', function(e) {
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const bottomThreshold = 50;

        const isAtBottom = scrollTop + windowHeight >= documentHeight - bottomThreshold;
        const isOverlayActive = greenTextOverlay.classList.contains('scroll-active');

        const touchCurrentY = e.touches[0].clientY;
        const touchDeltaY = touchStartY - touchCurrentY;
        const touchTime = Date.now() - touchStartTime;

        if (isOverlayActive) {

            if (touchDeltaY < -50) {
                greenTextOverlay.classList.remove('scroll-active');
                console.log('✓ Overlay closed by upward touch');

                return;
            } else {

                e.preventDefault();
                return;
            }
        }

        if (isAtBottom && touchDeltaY > 100) {
            greenTextOverlay.classList.add('scroll-active');
            e.preventDefault();
        }
    }, { passive: false });

    greenTextOverlay.addEventListener('click', function() {
        this.classList.remove('scroll-active');
    });

    greenTextContent.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            greenTextOverlay.classList.remove('scroll-active');
        }
        if (e.code === 'Space') {
            e.preventDefault();
            greenTextOverlay.classList.toggle('scroll-active');
        }
    });

}

function initializeImageInteraction() {
    const isMobile = !window.matchMedia('(hover: hover)').matches;

    document.addEventListener('click', function(e) {

        if (e.target.classList.contains('receipt-img') && !e.target.classList.contains('hidden')) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Image clicked:', e.target.dataset.month, e.target.dataset.index);
            openImageModal(e.target);
        }
    });

    if (!isMobile) {

        setTimeout(() => {
            allImages.forEach(img => {
                img.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('hidden')) {
                        this.style.transform = 'scale(1.1)';
                        this.style.zIndex = '300';
                    }
                });

                img.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('hidden')) {
                        this.style.transform = 'scale(1)';
                        this.style.zIndex = '250';
                    }
                });
            });
        }, 100);
    }
}

function openImageModal(img) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';

    const month = img.dataset.month;
    const index = parseInt(img.dataset.index) + 1; 
    let folderName = `${month}完成图（白描边`;
    if (month === '25.5') folderName = `${month}完成图(白描边`;
    if (month === '25.7') folderName = `${month}完成图（白描边）`;

    const timeCodeImagePath = `A页图片文案需求/A页image/${folderName}/${month}时间${index.toString().padStart(2, '0')}.png`;

    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h4>这是"收据图片"</h4>
                    <div class="receipt-img-container">
                        <img src="${img.src}" alt="收据图片" class="modal-receipt-img">
                        <button class="close-btn" onclick="closeImageModal()">&times;</button>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>这是"时间编码"</h4>
                    <img src="${timeCodeImagePath}" alt="时间编码" class="modal-time-code-img">
                    <p class="time-description">每个月份里"收据图片"和"时间编码"的文件数字后缀是一样的</p>
                </div>
            </div>
            <div class="modal-note">
                包含：<br>
                收据图片本身<br>
                图片下方收据对应的编号
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    document.body.style.overflow = 'hidden';

    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeImageModal();
        }
    });

    document.addEventListener('keydown', handleModalKeydown);
}

function closeImageModal() {
    const modal = document.querySelector('.image-modal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
        document.removeEventListener('keydown', handleModalKeydown);
    }
}

function handleModalKeydown(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
}

window.closeImageModal = closeImageModal;

function flyImage(img) {
    if (img.classList.contains('flying') || img.classList.contains('hidden')) {
        return;
    }

    const rect = img.getBoundingClientRect();
    const containerRect = img.parentElement.getBoundingClientRect();

    let currentX = parseFloat(img.style.left) || 0;
    let currentY = parseFloat(img.style.top) || 0;

    const distanceToLeft = currentX;
    const distanceToRight = containerRect.width - currentX - rect.width;
    const distanceToTop = currentY;
    const distanceToBottom = containerRect.height - currentY - rect.height;

    const maxLeft = Math.max(0, distanceToLeft - 20);
    const maxRight = Math.max(0, distanceToRight - 20);
    const maxUp = Math.max(0, distanceToTop - 20);
    const maxDown = Math.max(0, distanceToBottom - 20);

    const possibleDirections = [];
    if (maxLeft > 0) possibleDirections.push('left');
    if (maxRight > 0) possibleDirections.push('right');
    if (maxUp > 0) possibleDirections.push('up');
    if (maxDown > 0) possibleDirections.push('down');

    if (possibleDirections.length === 0) {
        return; 
    }

    const direction = possibleDirections[Math.floor(Math.random() * possibleDirections.length)];

    const moveDistance = 75; 

    let deltaX = 0, deltaY = 0;

    switch(direction) {
        case 'left':
            deltaX = -Math.min(moveDistance, maxLeft);
            break;
        case 'right':
            deltaX = Math.min(moveDistance, maxRight);
            break;
        case 'up':
            deltaY = -Math.min(moveDistance, maxUp);
            break;
        case 'down':
            deltaY = Math.min(moveDistance, maxDown);
            break;
    }

    const targetX = currentX + deltaX;
    const targetY = currentY + deltaY;

    img.style.setProperty('--current-transform', `translate(${currentX}px, ${currentY}px)`);
    img.style.setProperty('--target-transform', `translate(${targetX}px, ${targetY}px)`);

    img.classList.add('flying');

    setTimeout(() => {
        img.style.left = targetX + 'px';
        img.style.top = targetY + 'px';
        img.classList.remove('flying');
    }, 800); 
}

function initializeCountdownAnimation() {
    const countdownContainer = document.querySelector('.countdown-container');
    if (!countdownContainer) {
        console.error('Countdown container not found!');
        return;
    }

    const countdownTimer = countdownContainer.querySelector('.countdown-timer');
    if (!countdownTimer) {
        console.error('Countdown timer not found!');
        return;
    }

    const proofsContainer = document.querySelector('.proofs-container');
    const backgroundImages = document.querySelector('.background-images');

    function ensureScrollableHeight() {
        const minHeight = window.innerHeight * 2; 
        const currentHeight = backgroundImages.offsetHeight;

        if (currentHeight < minHeight) {
            backgroundImages.style.minHeight = minHeight + 'px';
            proofsContainer.style.minHeight = minHeight + 'px';
            console.log(`Extended page height to ${minHeight}px for scrolling`);
        }
    }

    function handleScroll() {
        const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
        const maxScroll = 400; 
        const scrollProgress = Math.min(scrollY / maxScroll, 1); 

        const startTop = 20;
        const endTop = window.innerHeight * 0.5;
        const currentTop = startTop + (endTop - startTop) * scrollProgress;

        const startScale = 0.5;
        const endScale = 1;
        const currentScale = startScale + (endScale - startScale) * scrollProgress;

        requestAnimationFrame(() => {
            countdownContainer.style.top = currentTop + 'px';
            countdownContainer.style.transform = `translateX(-50%) translateY(${scrollProgress > 0.5 ? '-50%' : '0'})`;
            countdownTimer.style.transform = `scale(${currentScale})`;

            const opacity = 0.7 + (0.3 * scrollProgress); 
            countdownContainer.style.opacity = opacity;
        });

        if (scrollY > 0) {
            console.log(`Scroll: ${scrollY}, Progress: ${scrollProgress.toFixed(2)}, Scale: ${currentScale.toFixed(2)}`);
        }
    }

    ensureScrollableHeight();

    window.scrollTo(0, 0);
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;

    handleScroll();

    setTimeout(() => {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
    }, 50);

    let ticking = false;
    function optimizedScrollHandler(e) {
        if (!ticking) {
            requestAnimationFrame(() => {
                handleScroll();
                ticking = false;
            });
            ticking = true;
        }
    }

    window.addEventListener('scroll', optimizedScrollHandler, { passive: true });
    document.addEventListener('scroll', optimizedScrollHandler, { passive: true });

    setTimeout(() => {
        handleScroll();

        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
        console.log(`Page height: ${document.body.scrollHeight}, Window height: ${window.innerHeight}, Can scroll: ${document.body.scrollHeight > window.innerHeight}`);
        console.log('Final position check - forced to top');
    }, 500);

    console.log('Countdown animation initialized with scrollable height');
}